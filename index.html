<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Finanz-Tracker Pro</title>
  <style>
    :root {
      --bg: #0a0e1a;
      --bg-secondary: #0f1419;
      --panel: #151b26;
      --panel-hover: #1a2130;
      --border: rgba(255,255,255,.08);
      --border-light: rgba(255,255,255,.05);
      --muted: #8b92a8;
      --text: #e8eaf0;
      --text-bright: #ffffff;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --accent-light: rgba(59,130,246,.15);
      --green: #10b981;
      --green-light: rgba(16,185,129,.15);
      --red: #ef4444;
      --red-light: rgba(239,68,68,.15);
      --orange: #f59e0b;
      --purple: #8b5cf6;
      --radius: 16px;
      --radius-sm: 12px;
      --shadow: 0 4px 24px rgba(0,0,0,.4);
      --shadow-lg: 0 20px 60px rgba(0,0,0,.5);
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; margin: 0; }
    body {
      background: linear-gradient(135deg, #0a0e1a 0%, #151b26 100%);
      color: var(--text);
      font: 16px/1.5 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom);
      overflow-x: hidden;
    }

    /* Header */
    .app-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(10,14,26,.95);
      backdrop-filter: blur(20px) saturate(180%);
      border-bottom: 1px solid var(--border);
      padding: 16px 20px;
    }
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .app-title {
      font-size: 22px;
      font-weight: 700;
      margin: 0;
      background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* Icon Button */
    .icon-btn {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all .2s ease;
      position: relative;
    }
    .icon-btn:hover {
      background: var(--panel-hover);
      border-color: var(--accent);
      transform: translateY(-1px);
    }
    .icon-btn:active {
      transform: translateY(0);
    }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Account Cards Grid */
    .accounts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .account-card {
      background: linear-gradient(135deg, var(--panel) 0%, var(--bg-secondary) 100%);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      position: relative;
      overflow: hidden;
      transition: all .3s ease;
      cursor: pointer;
    }
    .account-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), var(--purple));
      opacity: 0;
      transition: opacity .3s ease;
    }
    .account-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    .account-card:hover::before {
      opacity: 1;
    }

    .account-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    .account-name {
      font-size: 14px;
      color: var(--muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .5px;
    }
    .account-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: var(--accent-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .account-balance {
      font-size: 32px;
      font-weight: 800;
      color: var(--text-bright);
      margin: 8px 0;
      letter-spacing: -.5px;
    }
    .account-change {
      font-size: 13px;
      color: var(--muted);
    }

    /* Action Buttons */
    .action-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }
    .action-btn {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all .2s ease;
      color: var(--text);
    }
    .action-btn:hover {
      background: var(--panel-hover);
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    .action-btn-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: var(--accent-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    .action-btn-icon.green { background: var(--green-light); }
    .action-btn-icon.red { background: var(--red-light); }
    .action-btn-text {
      font-size: 14px;
      font-weight: 600;
    }

    /* Card */
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 20px;
      overflow: hidden;
    }
    .card-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card-title {
      font-size: 18px;
      font-weight: 700;
      margin: 0;
      color: var(--text-bright);
    }
    .card-body {
      padding: 20px;
    }

    /* Modal/Overlay */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,.7);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn .2s ease;
    }
    .modal-overlay.active {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 20px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      animation: slideUp .3s ease;
    }
    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: var(--bg-secondary);
      z-index: 10;
    }
    .modal-title {
      font-size: 20px;
      font-weight: 700;
      margin: 0;
      color: var(--text-bright);
    }
    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: none;
      background: var(--panel);
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .2s ease;
    }
    .modal-close:hover {
      background: var(--panel-hover);
      color: var(--text-bright);
    }
    .modal-body {
      padding: 24px;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: .5px;
    }
    .form-input, .form-select {
      width: 100%;
      height: 52px;
      padding: 0 16px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 16px;
      transition: all .2s ease;
      outline: none;
    }
    .form-input:focus, .form-select:focus {
      border-color: var(--accent);
      background: var(--bg-secondary);
      box-shadow: 0 0 0 4px rgba(59,130,246,.1);
    }
    .form-input::placeholder {
      color: var(--muted);
      opacity: .6;
    }

    /* Button */
    .btn {
      height: 52px;
      padding: 0 24px;
      border-radius: var(--radius-sm);
      border: none;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all .2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(59,130,246,.3);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59,130,246,.4);
    }
    .btn-primary:active {
      transform: translateY(0);
    }
    .btn-secondary {
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--text);
    }
    .btn-secondary:hover {
      background: var(--panel-hover);
      border-color: var(--accent);
    }
    .btn-danger {
      background: linear-gradient(135deg, var(--red) 0%, #dc2626 100%);
      color: white;
    }
    .btn-success {
      background: linear-gradient(135deg, var(--green) 0%, #059669 100%);
      color: white;
    }

    /* Account List in Settings */
    .account-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .account-item {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all .2s ease;
    }
    .account-item:hover {
      border-color: var(--accent);
    }
    .account-item-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }
    .account-item-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: var(--accent-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .account-item-details h4 {
      margin: 0 0 4px;
      font-size: 15px;
      color: var(--text-bright);
    }
    .account-item-details p {
      margin: 0;
      font-size: 13px;
      color: var(--muted);
    }
    .account-item-actions {
      display: flex;
      gap: 8px;
    }
    .btn-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .2s ease;
    }
    .btn-icon:hover {
      background: var(--panel-hover);
      border-color: var(--accent);
    }
    .btn-icon.danger:hover {
      background: var(--red-light);
      border-color: var(--red);
      color: var(--red);
    }

    /* Transaction History */
    .transaction-list {
      display: flex;
      flex-direction: column;
      gap: 1px;
      background: var(--border);
      border-radius: var(--radius-sm);
      overflow: hidden;
    }
    .transaction-item {
      background: var(--panel);
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background .2s ease;
    }
    .transaction-item:hover {
      background: var(--panel-hover);
    }
    .transaction-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }
    .transaction-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    .transaction-icon.income {
      background: var(--green-light);
      color: var(--green);
    }
    .transaction-icon.expense {
      background: var(--red-light);
      color: var(--red);
    }
    .transaction-icon.transfer {
      background: var(--accent-light);
      color: var(--accent);
    }
    .transaction-details h4 {
      margin: 0 0 4px;
      font-size: 15px;
      color: var(--text-bright);
    }
    .transaction-details p {
      margin: 0;
      font-size: 13px;
      color: var(--muted);
    }
    .transaction-amount {
      font-size: 16px;
      font-weight: 700;
      text-align: right;
    }
    .transaction-amount.positive {
      color: var(--green);
    }
    .transaction-amount.negative {
      color: var(--red);
    }

    /* Chart */
    .chart-container {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 20px;
      margin-bottom: 20px;
    }
    canvas {
      display: block;
      width: 100% !important;
      height: auto !important;
    }

    /* Alert/Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 16px 24px;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 2000;
      opacity: 0;
      transition: all .3s ease;
      max-width: 90%;
    }
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    .toast.success {
      border-color: var(--green);
      background: linear-gradient(135deg, var(--panel) 0%, rgba(16,185,129,.1) 100%);
    }
    .toast.error {
      border-color: var(--red);
      background: linear-gradient(135deg, var(--panel) 0%, rgba(239,68,68,.1) 100%);
    }
    .toast-icon {
      font-size: 20px;
    }
    .toast-message {
      font-size: 14px;
      font-weight: 600;
    }

    /* Responsive */
    @media (max-width: 640px) {
      .accounts-grid {
        grid-template-columns: 1fr;
      }
      .action-buttons {
        grid-template-columns: 1fr 1fr;
      }
      .account-balance {
        font-size: 28px;
      }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: .3;
    }
    .empty-state-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text);
    }
    .empty-state-text {
      font-size: 14px;
    }

    /* Divider */
    .divider {
      height: 1px;
      background: var(--border);
      margin: 24px 0;
    }

    /* Grid Layout for Form */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    @media (max-width: 640px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <div class="header-content">
      <h1 class="app-title">üíé FinanzPro</h1>
      <div class="header-actions">
        <button class="icon-btn" id="settingsBtn" title="Einstellungen">
          ‚öôÔ∏è
        </button>
      </div>
    </div>
  </header>

  <!-- Main Container -->
  <div class="container">
    <!-- Account Cards -->
    <div class="accounts-grid" id="accountsGrid">
      <!-- Accounts will be rendered here -->
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button class="action-btn" id="addIncomeBtn">
        <div class="action-btn-icon green">üí∞</div>
        <span class="action-btn-text">Einnahme</span>
      </button>
      <button class="action-btn" id="addExpenseBtn">
        <div class="action-btn-icon red">üí∏</div>
        <span class="action-btn-text">Ausgabe</span>
      </button>
      <button class="action-btn" id="transferBtn">
        <div class="action-btn-icon">üîÑ</div>
        <span class="action-btn-text">√úberweisung</span>
      </button>
    </div>

    <!-- Chart -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">üìä √úbersicht</h2>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="mainChart" height="200"></canvas>
        </div>
      </div>
    </div>

    <!-- Transaction History -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">üìú Transaktionen</h2>
      </div>
      <div class="card-body">
        <div class="transaction-list" id="transactionList">
          <!-- Transactions will be rendered here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">‚öôÔ∏è Einstellungen</h2>
        <button class="modal-close" id="closeSettingsBtn">‚úï</button>
      </div>
      <div class="modal-body">
        <h3 style="margin-top: 0; font-size: 16px; color: var(--text-bright);">Konten verwalten</h3>
        <div class="account-list" id="accountSettingsList">
          <!-- Account settings will be rendered here -->
        </div>
        
        <div class="divider"></div>
        
        <h3 style="font-size: 16px; color: var(--text-bright);">Neues Konto hinzuf√ºgen</h3>
        <div class="form-group">
          <label class="form-label">Kontoname</label>
          <input type="text" class="form-input" id="newAccountName" placeholder="z.B. Sparkonto, Notgroschen..." maxlength="30">
        </div>
        <div class="form-group">
          <label class="form-label">Icon (Emoji)</label>
          <input type="text" class="form-input" id="newAccountIcon" placeholder="üí∞" maxlength="2">
        </div>
        <div class="form-group">
          <label class="form-label">Startguthaben (CHF)</label>
          <input type="number" class="form-input" id="newAccountBalance" placeholder="0.00" step="0.01" min="0">
        </div>
        <button class="btn btn-primary" id="addAccountBtn">‚ûï Konto hinzuf√ºgen</button>

        <div class="divider"></div>

        <button class="btn btn-danger" id="resetAllBtn">üóëÔ∏è Alle Daten l√∂schen</button>
      </div>
    </div>
  </div>

  <!-- Transaction Modal (Income/Expense) -->
  <div class="modal-overlay" id="transactionModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="transactionModalTitle">üí∞ Transaktion</h2>
        <button class="modal-close" id="closeTransactionBtn">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Konto</label>
          <select class="form-select" id="transactionAccount">
            <!-- Options will be populated -->
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Betrag (CHF)</label>
          <input type="number" class="form-input" id="transactionAmount" placeholder="0.00" step="0.01" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">Beschreibung (optional)</label>
          <input type="text" class="form-input" id="transactionDesc" placeholder="z.B. Gehalt, Einkauf..." maxlength="80">
        </div>
        <button class="btn btn-primary" id="submitTransactionBtn">‚úì Best√§tigen</button>
      </div>
    </div>
  </div>

  <!-- Transfer Modal -->
  <div class="modal-overlay" id="transferModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">üîÑ √úberweisung</h2>
        <button class="modal-close" id="closeTransferBtn">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Von Konto</label>
          <select class="form-select" id="transferFrom">
            <!-- Options will be populated -->
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Zu Konto</label>
          <select class="form-select" id="transferTo">
            <!-- Options will be populated -->
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Betrag (CHF)</label>
          <input type="number" class="form-input" id="transferAmount" placeholder="0.00" step="0.01" min="0">
        </div>
        <button class="btn btn-primary" id="submitTransferBtn">‚úì √úberweisen</button>
      </div>
    </div>
  </div>

  <!-- Edit Account Modal -->
  <div class="modal-overlay" id="editAccountModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">‚úèÔ∏è Konto bearbeiten</h2>
        <button class="modal-close" id="closeEditAccountBtn">‚úï</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editAccountId">
        <div class="form-group">
          <label class="form-label">Kontostand (CHF)</label>
          <input type="number" class="form-input" id="editAccountBalance" step="0.01">
        </div>
        <button class="btn btn-success" id="submitEditAccountBtn">‚úì Speichern</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <span class="toast-icon" id="toastIcon">‚úì</span>
    <span class="toast-message" id="toastMessage"></span>
  </div>

  <script>
    // --- State Management ---
    const STORAGE_KEY = 'finanzpro-v2';
    const CURRENCY = 'CHF';
    const fmt = new Intl.NumberFormat('de-CH', { style: 'currency', currency: CURRENCY, maximumFractionDigits: 2 });

    let state = {
      accounts: [
        { id: 'privat', name: 'Privatkonto', icon: 'üí≥', balance: 0 },
        { id: 'spar', name: 'Sparkonto', icon: 'üè¶', balance: 0 }
      ],
      transactions: [],
      stats: { totalIncome: 0, totalExpense: 0 }
    };

    // Load state from localStorage
    function loadState() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          state = { ...state, ...parsed };
        }
      } catch (e) {
        console.error('Failed to load state', e);
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    // --- Utilities ---
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function formatDate(date) {
      return new Date(date).toLocaleString('de-CH', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastIcon = document.getElementById('toastIcon');
      const toastMessage = document.getElementById('toastMessage');

      toast.className = 'toast ' + type;
      toastIcon.textContent = type === 'success' ? '‚úì' : '‚úï';
      toastMessage.textContent = message;

      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // --- Rendering ---
    function renderAccounts() {
      const grid = document.getElementById('accountsGrid');
      grid.innerHTML = '';

      if (state.accounts.length === 0) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1/-1;">
            <div class="empty-state-icon">üè¶</div>
            <h3 class="empty-state-title">Keine Konten vorhanden</h3>
            <p class="empty-state-text">F√ºge dein erstes Konto in den Einstellungen hinzu</p>
          </div>
        `;
        return;
      }

      state.accounts.forEach(account => {
        const card = document.createElement('div');
        card.className = 'account-card';
        card.innerHTML = `
          <div class="account-header">
            <div class="account-name">${account.name}</div>
            <div class="account-icon">${account.icon}</div>
          </div>
          <div class="account-balance">${fmt.format(account.balance)}</div>
          <div class="account-change">Aktueller Stand</div>
        `;
        grid.appendChild(card);
      });
    }

    function renderAccountSettings() {
      const list = document.getElementById('accountSettingsList');
      list.innerHTML = '';

      if (state.accounts.length === 0) {
        list.innerHTML = '<p style="color: var(--muted); text-align: center;">Keine Konten vorhanden</p>';
        return;
      }

      state.accounts.forEach(account => {
        const item = document.createElement('div');
        item.className = 'account-item';
        item.innerHTML = `
          <div class="account-item-info">
            <div class="account-item-icon">${account.icon}</div>
            <div class="account-item-details">
              <h4>${account.name}</h4>
              <p>${fmt.format(account.balance)}</p>
            </div>
          </div>
          <div class="account-item-actions">
            <button class="btn-icon" onclick="editAccount('${account.id}')" title="Bearbeiten">‚úèÔ∏è</button>
            <button class="btn-icon danger" onclick="deleteAccount('${account.id}')" title="L√∂schen">üóëÔ∏è</button>
          </div>
        `;
        list.appendChild(item);
      });
    }

    function renderTransactions() {
      const list = document.getElementById('transactionList');
      list.innerHTML = '';

      if (state.transactions.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìú</div>
            <h3 class="empty-state-title">Keine Transaktionen</h3>
            <p class="empty-state-text">Deine Transaktionen werden hier angezeigt</p>
          </div>
        `;
        return;
      }

      const recent = state.transactions.slice().reverse().slice(0, 50);
      recent.forEach(tx => {
        const item = document.createElement('div');
        item.className = 'transaction-item';
        
        let icon = 'üí∞';
        let iconClass = 'income';
        let amountClass = 'positive';
        let amountPrefix = '+';
        
        if (tx.type === 'expense') {
          icon = 'üí∏';
          iconClass = 'expense';
          amountClass = 'negative';
          amountPrefix = '-';
        } else if (tx.type === 'transfer') {
          icon = 'üîÑ';
          iconClass = 'transfer';
          amountPrefix = '';
          amountClass = '';
        }

        const account = state.accounts.find(a => a.id === tx.accountId);
        const accountName = account ? account.name : 'Unbekannt';

        item.innerHTML = `
          <div class="transaction-info">
            <div class="transaction-icon ${iconClass}">${icon}</div>
            <div class="transaction-details">
              <h4>${tx.description || (tx.type === 'income' ? 'Einnahme' : tx.type === 'expense' ? 'Ausgabe' : '√úberweisung')}</h4>
              <p>${accountName} ‚Ä¢ ${formatDate(tx.date)}</p>
            </div>
          </div>
          <div class="transaction-amount ${amountClass}">
            ${amountPrefix}${fmt.format(tx.amount)}
          </div>
        `;
        list.appendChild(item);
      });
    }

    function populateAccountSelects() {
      const selects = ['transactionAccount', 'transferFrom', 'transferTo'];
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        select.innerHTML = state.accounts.map(acc => 
          `<option value="${acc.id}">${acc.icon} ${acc.name}</option>`
        ).join('');
      });
    }

    function renderChart() {
      const canvas = document.getElementById('mainChart');
      const ctx = canvas.getContext('2d');
      
      const ratio = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * ratio;
      canvas.height = rect.height * ratio;
      ctx.scale(ratio, ratio);

      const w = rect.width;
      const h = rect.height;

      ctx.clearRect(0, 0, w, h);

      // Draw bars
      const income = state.stats.totalIncome;
      const expense = state.stats.totalExpense;
      const max = Math.max(income, expense, 1);
      const scale = (h - 60) / (max * 1.2);

      const barWidth = Math.min(w / 4, 100);
      const gap = 40;
      const startX = (w - (barWidth * 2 + gap)) / 2;

      // Income bar
      const incomeHeight = income * scale;
      ctx.fillStyle = '#10b981';
      roundRect(ctx, startX, h - 40 - incomeHeight, barWidth, incomeHeight, 8);
      ctx.fill();

      // Expense bar
      const expenseHeight = expense * scale;
      ctx.fillStyle = '#ef4444';
      roundRect(ctx, startX + barWidth + gap, h - 40 - expenseHeight, barWidth, expenseHeight, 8);
      ctx.fill();

      // Labels
      ctx.fillStyle = '#e8eaf0';
      ctx.font = '14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto';
      ctx.textAlign = 'center';
      ctx.fillText('Einnahmen', startX + barWidth / 2, h - 20);
      ctx.fillText('Ausgaben', startX + barWidth + gap + barWidth / 2, h - 20);

      ctx.font = 'bold 16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto';
      ctx.fillText(fmt.format(income), startX + barWidth / 2, h - 50 - incomeHeight);
      ctx.fillText(fmt.format(expense), startX + barWidth + gap + barWidth / 2, h - 50 - expenseHeight);
    }

    function roundRect(ctx, x, y, w, h, r) {
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.lineTo(x + w - r, y);
      ctx.quadraticCurveTo(x + w, y, x + w, y + r);
      ctx.lineTo(x + w, y + h - r);
      ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
      ctx.lineTo(x + r, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - r);
      ctx.lineTo(x, y + r);
      ctx.quadraticCurveTo(x, y, x + r, y);
      ctx.closePath();
    }

    // --- Actions ---
    function addAccount() {
      const name = document.getElementById('newAccountName').value.trim();
      const icon = document.getElementById('newAccountIcon').value.trim() || 'üí∞';
      const balance = parseFloat(document.getElementById('newAccountBalance').value) || 0;

      if (!name) {
        showToast('Bitte einen Kontonamen eingeben', 'error');
        return;
      }

      const account = {
        id: generateId(),
        name,
        icon,
        balance
      };

      state.accounts.push(account);
      saveState();
      renderAccounts();
      renderAccountSettings();
      populateAccountSelects();
      
      document.getElementById('newAccountName').value = '';
      document.getElementById('newAccountIcon').value = '';
      document.getElementById('newAccountBalance').value = '';

      showToast('Konto erfolgreich hinzugef√ºgt');
    }

    function deleteAccount(id) {
      if (state.accounts.length <= 1) {
        showToast('Du musst mindestens ein Konto behalten', 'error');
        return;
      }

      if (!confirm('M√∂chtest du dieses Konto wirklich l√∂schen?')) return;

      state.accounts = state.accounts.filter(a => a.id !== id);
      state.transactions = state.transactions.filter(t => t.accountId !== id);
      saveState();
      renderAll();
      showToast('Konto gel√∂scht');
    }

    function editAccount(id) {
      const account = state.accounts.find(a => a.id === id);
      if (!account) return;

      document.getElementById('editAccountId').value = id;
      document.getElementById('editAccountBalance').value = account.balance;
      document.getElementById('editAccountModal').classList.add('active');
    }

    function saveEditAccount() {
      const id = document.getElementById('editAccountId').value;
      const balance = parseFloat(document.getElementById('editAccountBalance').value);

      if (isNaN(balance) || balance < 0) {
        showToast('Bitte einen g√ºltigen Betrag eingeben', 'error');
        return;
      }

      const account = state.accounts.find(a => a.id === id);
      if (account) {
        account.balance = balance;
        saveState();
        renderAll();
        closeModal('editAccountModal');
        showToast('Kontostand aktualisiert');
      }
    }

    let currentTransactionType = 'income';

    function openTransactionModal(type) {
      currentTransactionType = type;
      const title = type === 'income' ? 'üí∞ Einnahme hinzuf√ºgen' : 'üí∏ Ausgabe hinzuf√ºgen';
      document.getElementById('transactionModalTitle').textContent = title;
      document.getElementById('transactionModal').classList.add('active');
    }

    function submitTransaction() {
      const accountId = document.getElementById('transactionAccount').value;
      const amount = parseFloat(document.getElementById('transactionAmount').value);
      const description = document.getElementById('transactionDesc').value.trim();

      if (!accountId || isNaN(amount) || amount <= 0) {
        showToast('Bitte alle Felder korrekt ausf√ºllen', 'error');
        return;
      }

      const account = state.accounts.find(a => a.id === accountId);
      if (!account) return;

      if (currentTransactionType === 'expense' && account.balance < amount) {
        showToast('Nicht gen√ºgend Guthaben', 'error');
        return;
      }

      const transaction = {
        id: generateId(),
        type: currentTransactionType,
        accountId,
        amount,
        description,
        date: new Date().toISOString()
      };

      if (currentTransactionType === 'income') {
        account.balance += amount;
        state.stats.totalIncome += amount;
      } else {
        account.balance -= amount;
        state.stats.totalExpense += amount;
      }

      state.transactions.push(transaction);
      saveState();
      renderAll();
      closeModal('transactionModal');

      document.getElementById('transactionAmount').value = '';
      document.getElementById('transactionDesc').value = '';

      showToast(currentTransactionType === 'income' ? 'Einnahme erfasst' : 'Ausgabe erfasst');
    }

    function submitTransfer() {
      const fromId = document.getElementById('transferFrom').value;
      const toId = document.getElementById('transferTo').value;
      const amount = parseFloat(document.getElementById('transferAmount').value);

      if (!fromId || !toId || isNaN(amount) || amount <= 0) {
        showToast('Bitte alle Felder korrekt ausf√ºllen', 'error');
        return;
      }

      if (fromId === toId) {
        showToast('Quell- und Zielkonto m√ºssen unterschiedlich sein', 'error');
        return;
      }

      const fromAccount = state.accounts.find(a => a.id === fromId);
      const toAccount = state.accounts.find(a => a.id === toId);

      if (!fromAccount || !toAccount) return;

      if (fromAccount.balance < amount) {
        showToast('Nicht gen√ºgend Guthaben', 'error');
        return;
      }

      fromAccount.balance -= amount;
      toAccount.balance += amount;

      const transaction = {
        id: generateId(),
        type: 'transfer',
        accountId: fromId,
        toAccountId: toId,
        amount,
        description: `Transfer: ${fromAccount.name} ‚Üí ${toAccount.name}`,
        date: new Date().toISOString()
      };

      state.transactions.push(transaction);
      saveState();
      renderAll();
      closeModal('transferModal');

      document.getElementById('transferAmount').value = '';
      showToast('√úberweisung erfolgreich');
    }

    function resetAll() {
      if (!confirm('M√∂chtest du wirklich alle Daten l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.')) return;

      state = {
        accounts: [],
        transactions: [],
        stats: { totalIncome: 0, totalExpense: 0 }
      };
      saveState();
      renderAll();
      closeModal('settingsModal');
      showToast('Alle Daten wurden gel√∂scht');
    }

    // --- Modal Management ---
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // --- Event Listeners ---
    document.getElementById('settingsBtn').addEventListener('click', () => {
      document.getElementById('settingsModal').classList.add('active');
    });

    document.getElementById('closeSettingsBtn').addEventListener('click', () => {
      closeModal('settingsModal');
    });

    document.getElementById('addAccountBtn').addEventListener('click', addAccount);

    document.getElementById('addIncomeBtn').addEventListener('click', () => {
      if (state.accounts.length === 0) {
        showToast('Bitte zuerst ein Konto erstellen', 'error');
        return;
      }
      openTransactionModal('income');
    });

    document.getElementById('addExpenseBtn').addEventListener('click', () => {
      if (state.accounts.length === 0) {
        showToast('Bitte zuerst ein Konto erstellen', 'error');
        return;
      }
      openTransactionModal('expense');
    });

    document.getElementById('transferBtn').addEventListener('click', () => {
      if (state.accounts.length < 2) {
        showToast('Du ben√∂tigst mindestens 2 Konten f√ºr eine √úberweisung', 'error');
        return;
      }
      document.getElementById('transferModal').classList.add('active');
    });

    document.getElementById('closeTransactionBtn').addEventListener('click', () => {
      closeModal('transactionModal');
    });

    document.getElementById('submitTransactionBtn').addEventListener('click', submitTransaction);

    document.getElementById('closeTransferBtn').addEventListener('click', () => {
      closeModal('transferModal');
    });

    document.getElementById('submitTransferBtn').addEventListener('click', submitTransfer);

    document.getElementById('closeEditAccountBtn').addEventListener('click', () => {
      closeModal('editAccountModal');
    });

    document.getElementById('submitEditAccountBtn').addEventListener('click', saveEditAccount);

    document.getElementById('resetAllBtn').addEventListener('click', resetAll);

    // Close modals on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('active');
        }
      });
    });

    // --- Render All ---
    function renderAll() {
      renderAccounts();
      renderAccountSettings();
      renderTransactions();
      populateAccountSelects();
      renderChart();
    }

    // --- Initialize ---
    loadState();
    renderAll();

    // Responsive chart
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(renderChart, 150);
    });
  </script>
</body>
</html>
